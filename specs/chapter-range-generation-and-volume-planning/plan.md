# Implementation Plan（Spec-Kit）

## Phase 1: API 合同与参数校验（区间生成底座）
1. 扩展 `BootstrapRequest`（仅章节场景使用）：
   - `start_chapter: Optional[int]`
   - `end_chapter: Optional[int]`
   - `batch_size: Optional[int]`
2. 新增参数校验与优先级判定：
   - `start >= 1`
   - `end >= start`
   - `scope != chapters` 时拒绝区间参数
   - `start/end` 存在时覆盖 `chapter_count` 语义
3. 响应增强：
   - 返回本次有效区间
   - 返回批次统计（总批次/成功批次）
   - 返回降批重试次数
4. 向后兼容约束：
   - 保留 `BootstrapResponse` 既有字段 `inserted/skipped/message`
   - 非章节 scope（角色/世界观/大纲）行为与当前实现一致
   - `scope=planning` 作为历史别名保留旧语义，不参与区间生成

## Phase 2: 区间批次引擎与超时兜底
1. 区间切片器（start/end -> 多批次）
2. 默认批次策略：
   - 首选 40（或配置值）
   - 超时降为 20
   - 仍超时降为 10
3. 批次事务策略：
   - 每批次独立写入，失败不回滚已成功批次
4. 失败恢复：
   - 返回最后成功位置，支持用户从失败段继续
5. 区间模式专用约束：
   - 禁用“1..chapter_count 全覆盖补齐”
   - 章节编号约束改为 `start..end`
   - fallback 生成器改为区间模式
   - 统一使用绝对章号写库（禁止 1..N 相对编号直接入库）

## Phase 3: 连贯性上下文注入强化
1. 章节场景注入圣经 4.1~4.4 执行指令（与 1~3 核心约束）
2. 注入已有设定：
   - 角色/世界观/全书骨架大纲
3. 注入最近章节摘要链（N=10~20，可配置）
4. 注入伏笔快照（至少未回收关键项）
5. 若存在卷级结果，注入当前区间所属卷目标
6. 章节格式约束提取器：
   - 优先抽取圣经 `4.4` 的输出格式要求
   - 写入章节 prompt 的“强约束区”
   - 若 `4.4` 缺失则启用系统默认格式并标记降级
7. 增加卷标签动态化处理器：
   - 将 `4.4` 中“第一卷/第1卷”等样例识别为模板占位
   - 运行时按 `volume_index/volume_title/chapter_range` 替换
   - 区间无卷映射时回退为“第X章-第Y章区间”

## Phase 4: 前端章节管理区间交互
1. 章节页新增范围输入：
   - 起始章、结束章
   - 快捷按钮（下一批20章）
2. 组装请求：
   - `scope=chapters`
   - `start_chapter/end_chapter`
   - `force`（区间覆盖）
3. 执行反馈：
   - 批次进度
   - 区间统计
   - 错误可读提示（建议缩小区间/自动重试）

## Phase 5: 卷级扩展能力（上层策略）
1. 新增卷级扩展接口：
   - 输入：目标总字数、目标卷数
   - 输出：每卷五元信息（卷名/章范围/目标/转折/卷尾钩子）
   - 卷级数据独立落库（`volume_plans`），不复用 `outlines`
2. 卷级展示与编辑：
   - 在大纲页增加卷级视图/入口
3. 按卷触发章节生成：
   - 选中卷后自动填充区间并调用章节生成
   - 同时传递卷上下文（卷序号/卷名/章范围）用于 `4.4` 动态替换

## Phase 6: 验证与回归
1. Python 编译与前端构建通过
2. 手工回归场景：
   - 152 章区间生成
   - 覆盖区间仅影响区间内
   - 批次失败后可继续
   - 卷级扩展后按卷生成可跑通
   - 第2卷、第3卷生成不再出现“第一卷”误标
   - 角色页/世界观页/大纲页原有功能无回归
   - 目标章节 > 300 时区间生成仍可执行（不被全量上限错误拦截）
