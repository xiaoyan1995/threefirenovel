# Feature Spec: 章节区间生成 + 卷级扩展（Spec-Kit）

## 背景
当前项目已具备：
- 小说圣经生成与版本化
- 圣经驱动的结构化生成（角色/世界观/大纲/章节）
- 章节管理页 AI 章节规划入口

已观察到的关键问题：
- 当目标章节较大（如 152 章）时，章节规划易出现超时（500 / APITimeoutError）
- 用户希望可按“数量/区间”生成章节，而不是每次全量
- 用户希望超长体量（百万字、千章级）具备可持续的滚动规划方式
- 用户希望“圣经一键、卷级规划、章节生成”职责清晰、互不冲突
- 用户担心圣经 `4.4` 示例中若写死“第一卷”，在第二/第三卷生成时被错误沿用

## 目标
1. 提供“章节区间生成”能力（start/end），支持按段滚动生成。
2. 提供超时兜底：批次化生成 + 自动降批重试，避免长任务直接失败。
3. 确保区间生成使用已有资料（圣经/设定/大纲/最近章节链）降低不连贯风险。
4. 新增“卷级扩展”能力：基于总字数和目标卷数自动产出卷级大纲。
5. 明确三层职责边界：圣经一键 -> 卷级扩展 -> 区间章节生成。

## 非目标
- 本轮不做大规模数据库重构；仅允许为卷级规划新增最小必要表结构。
- 本轮不重写正文写作引擎（chapter_writer 流程保持原逻辑）。
- 本轮不引入多租户/远程任务队列。
- 本轮不改变角色/世界观/大纲既有 CRUD 与生成入口行为。

## 职责边界（防冲突）
1. 圣经一键只负责：角色、世界观、全书骨架大纲。
2. 卷级扩展只负责：卷名、章范围、卷目标、关键转折、卷尾钩子。
3. 章节区间生成只负责：章节标题与章节梗概。
4. `force` 仅作用于本次区间，不得扩散到区间外。

## 章节提示词规范（硬约束）
1. 章节生成提示词的“输出格式与字段要求”必须以小说圣经 `4.4` 为唯一准绳。
2. 若系统内置章节格式规则与 `4.4` 存在冲突，必须以 `4.4` 覆盖内置规则。
3. `4.1~4.3` 仍用于角色/世界观/大纲相关语义约束；但章节输出格式（字段、表达粒度、格式约束）以 `4.4` 为主。
4. 当 `4.4` 缺失或不完整时，系统可使用内置兜底格式，但需在响应中显式提示“已降级到系统默认格式”。
5. `4.4` 中出现“第一卷/第1卷/第一部”等卷标签时，默认视为“格式示例”而非固定字面值；运行时必须按当前生成区间所属卷动态替换。
6. 若当前区间未映射到任何卷计划，则卷标签必须退化为“第X章-第Y章区间”语义，禁止硬写“第一卷”。

## 功能需求

### FR-1 章节区间生成
1. `POST /api/pipeline/bootstrap` 在 `scope=chapters` 下支持：
   - `start_chapter`（可选）
   - `end_chapter`（可选）
   - `batch_size`（可选，默认由系统策略决定）
2. 当 `start_chapter/end_chapter` 提供时，仅生成该区间章节。
3. 参数冲突优先级：
   - `start/end` > `chapter_count` > 圣经默认章节数推导。
4. 兼容性要求：
   - `scope != chapters` 时若传入区间参数，必须直接返回可读参数错误；
   - `scope=outline/characters/worldbuilding` 原行为保持不变。
   - `scope=planning` 视为历史别名能力，默认不接收区间参数（避免“同时生成大纲+章节”的语义冲突）。
5. 区间生成编号规则：
   - 输出与入库必须使用“绝对章号”（即 `start_chapter..end_chapter`）；
   - 禁止把区间内章节重映射为 `1..N` 临时编号后直接写库。

### FR-2 批次化与超时兜底
1. 区间生成采用批次执行，默认 20~40 章/批。
2. 单批超时后自动降批重试：40 -> 20 -> 10。
3. 若仍失败，返回“最后成功批次 + 失败区间”以便继续重试。

### FR-3 连贯性上下文注入
区间章节生成时必须注入：
1. 小说圣经约束（章节场景至少覆盖 4.1~4.4）
2. 已生成角色/世界观/全书骨架大纲
3. 最近章节摘要链（建议最近 10~20 章）
4. 伏笔状态快照（简版：未回收/已回收关键点）
5. 卷级目标（若已存在卷级计划）
6. 章节输出格式模板优先读取 `4.4`，并将其格式要求写入 prompt 的显式约束段。
7. 若 `4.4` 包含卷标签样例，生成前必须执行“卷标签动态替换”（当前卷名/卷序号/章范围）。

### FR-4 覆盖策略
1. 默认：仅补空章节，不覆盖已有有效标题/梗概。
2. `force=true`：仅覆盖当前区间章节。
3. 区间外数据严格不变。

### FR-5 前端章节管理交互
1. 增加“生成范围”输入：
   - 起始章
   - 结束章
   - 可选快捷（下一批20章）
2. 保留并兼容“覆盖重生成章节”开关。
3. 增加执行反馈：
   - 当前批次进度
   - 实际生成区间
   - 新增/跳过/覆盖统计

### FR-6 卷级扩展（新增）
1. 提供“从圣经骨架扩展卷级”入口。
2. 输入：
   - 目标总字数（如 500 万）
   - 目标卷数（如 12 卷）
3. 输出每卷：
   - 卷名
   - 章范围
   - 本卷目标
   - 关键转折
   - 卷尾钩子
4. 卷级结果可作为章节区间生成的上游条件。
5. 卷级数据必须独立存储，禁止直接复用 `outlines` 表，避免污染现有大纲页展示与编辑逻辑。

### FR-7 卷标签动态化（防“第一卷”串卷）
1. 当用户“按卷生成章节”时，系统必须传递并注入：
   - `volume_index`
   - `volume_title`
   - `volume_start_chapter`
   - `volume_end_chapter`
2. 章节 prompt 组装阶段必须在 `4.4` 模板上执行卷标签替换，确保卷序号与区间一致。
3. 若检测到生成结果仍出现错误卷标签（例如第2卷区间出现“第一卷”），需自动触发一次轻量重试（仅修复卷标签，不重写剧情语义）。

## 安全与质量约束
1. 不允许无参数全量覆盖已有章节（除非显式全量操作并二次确认）。
2. 长任务必须可恢复（中途失败可从失败批次续跑）。
3. 响应错误必须可读，避免仅暴露底层 provider 异常字符串。
4. `BootstrapResponse` 必须向后兼容，保留 `inserted/skipped/message` 既有字段。

## 验收标准
1. 152 章项目可按区间稳定生成，不再频繁出现 60 秒超时失败。
2. 分批生成后，章节编号连续且无重复/越界写入。
3. 区间生成默认不覆盖已有有效章节；开启覆盖仅影响区间内。
4. 卷级扩展可输出完整卷计划，并能驱动按卷生成章节。
5. 圣经一键、卷级扩展、章节生成三者职责清晰且无覆盖冲突。
6. 章节生成输出格式与字段满足圣经 `4.4` 规则；存在冲突时以 `4.4` 为准。
7. 第2卷、第3卷区间生成时不出现“第一卷”误标；卷标签与区间映射一致。
8. 角色页、世界观页、大纲页原有 AI 生成功能与 CRUD 不受本特性影响。
