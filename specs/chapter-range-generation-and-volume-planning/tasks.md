# Tasks（Spec-Kit）

## Backend - API 合同
- [x] T-API-001 扩展 `BootstrapRequest` 增加 `start_chapter/end_chapter/batch_size`（章节场景）。
- [x] T-API-002 增加请求参数校验（start/end合法性、scope适用性）。
- [x] T-API-003 定义参数优先级：`start/end` > `chapter_count` > 圣经默认推导。
- [x] T-API-004 响应模型增强：包含有效区间、批次统计、降级重试信息。
- [x] T-API-005 错误消息标准化：超时/参数冲突/越界写入均返回可读提示。
- [x] T-API-006 `BootstrapResponse` 向后兼容：保留 `inserted/skipped/message` 既有字段，不得删除或改名。
- [x] T-API-007 非章节 scope 行为锁定：`outline/characters/worldbuilding` 逻辑不受区间参数影响（收到区间参数直接校验报错）。
- [x] T-API-008 `scope=planning` 兼容策略明确（建议视为旧别名并禁用区间参数，避免语义歧义）。

## Backend - 区间批次引擎
- [x] T-GEN-101 实现区间切片器（按 batch_size 拆分）。
- [x] T-GEN-102 实现默认批次策略（20~40章/批）及上限保护。
- [x] T-GEN-103 实现超时降批重试链路（40->20->10）。
- [x] T-GEN-104 实现“每批独立事务写入”。
- [x] T-GEN-105 实现失败恢复点返回（最后成功批次、失败区间）。
- [x] T-GEN-106 实现区间边界写入保护（禁止区间外写入）。
- [x] T-GEN-107 实现默认补空策略（不覆盖已有有效章节）。
- [x] T-GEN-108 实现 `force=true` 仅覆盖当前区间逻辑。
- [x] T-GEN-109 区间模式禁用全量补齐：不得调用“1..chapter_count 全覆盖补齐”逻辑。
- [x] T-GEN-110 区间模式下章节约束改为 `start..end`，不得继续使用“1..chapter_count 连续”硬约束。
- [x] T-GEN-111 回退生成器（fallback）支持区间模式，避免回退时误生成全量章节。
- [x] T-GEN-112 幂等写入保护：同一项目 `chapter_num` 避免重复写入（建议迁移增加唯一约束或等价防重策略）。
- [x] T-GEN-113 绝对章号写库：区间模式生成与落库使用 `start..end` 绝对编号，不得以 `1..N` 相对编号直接入库。
- [x] T-GEN-114 拆分“章节总量上限”和“单批处理上限”：避免现有 300 章上限误伤高章号区间生成（如 401-420）。
- [x] T-GEN-115 若采用唯一约束方案，迁移前执行重复 `chapter_num` 数据清理与保底回滚策略。

## Backend - 连贯性上下文
- [x] T-CTX-201 注入圣经章节场景执行指令（4.1~4.4）与核心约束（1~3）。
- [x] T-CTX-202 注入已有角色/世界观/全书骨架大纲。
- [x] T-CTX-203 注入最近章节摘要链（可配置 N，默认 10~20）。
- [x] T-CTX-204 注入伏笔快照（未回收优先）。
- [x] T-CTX-205 若存在卷级计划，注入当前区间所属卷目标。
- [x] T-CTX-206 增加上下文预算裁剪，避免 prompt 过长导致二次超时。
- [x] T-CTX-207 章节 prompt 格式锚定到圣经 `4.4`（字段与格式规则以 `4.4` 为准）。
- [x] T-CTX-208 若检测到 `4.4` 缺失/不可解析，启用内置格式兜底并在响应中标记降级。
- [x] T-CTX-209 实现 `4.4` 卷标签动态替换器（将“第一卷/第1卷”等样例替换为当前卷上下文）。
- [x] T-CTX-210 区间无卷映射时，卷标签降级为“第X章-第Y章区间”语义，禁止硬写“第一卷”。
- [x] T-CTX-211 增加卷标签一致性后置校验（生成结果卷标签与目标卷不一致时触发轻量修复重试）。

## Frontend - 章节管理页
- [x] T-FE-301 增加“生成范围”输入（起始章、结束章）。
- [x] T-FE-302 增加快捷按钮“下一批20章”。
- [x] T-FE-303 保留并兼容“覆盖重生成章节”开关。
- [x] T-FE-304 请求改造：提交 `scope=chapters + start/end + force`。
- [x] T-FE-305 增加执行进度反馈（第X批/共Y批）。
- [x] T-FE-306 增加结果摘要展示（新增/跳过/覆盖 + 实际区间）。
- [x] T-FE-307 超时场景提示优化（建议缩小区间、建议重试）。

## 卷级扩展（上层能力）
- [x] T-VOL-401 新增卷级扩展接口（输入总字数+目标卷数，输出卷级计划）。
- [x] T-VOL-402 卷级数据独立落库（新增 `volume_plans` 表），禁止复用 `outlines` 表以避免污染现有大纲页。
- [x] T-VOL-403 大纲页增加“骨架视图/卷级视图”切换。
- [x] T-VOL-404 提供“按卷生成章节”入口，自动带区间参数。
- [x] T-VOL-405 增加卷计划一致性检查（范围覆盖、无重叠、无缺口）。
- [x] T-VOL-406 按卷生成请求附带卷上下文字段（`volume_index/title/start/end`）。

## 兼容与回归
- [x] T-REG-501 圣经一键（角色/世界观/骨架大纲）回归通过。
- [x] T-REG-502 章节单独生成（无区间参数）保持旧行为兼容。
- [x] T-REG-503 区间生成默认不覆盖；开启 force 后仅覆盖区间内。
- [x] T-REG-504 152 章项目分批生成通过，无致命超时中断。
- [x] T-REG-505 构建与编译通过：`python -m py_compile` + `npm run build`。
- [x] T-REG-506 章节输出格式回归：与圣经 `4.4` 一致（冲突时以 `4.4` 覆盖内置模板）。
- [x] T-REG-507 第二卷/第三卷区间生成回归：卷标签与区间一致，不出现“第一卷”误标。
- [x] T-REG-508 非章节能力回归：角色页、世界观页、大纲页原有 AI 生成与 CRUD 均不受影响。
- [x] T-REG-509 大纲页回归：仅显示骨架大纲，不混入卷级计划数据。
- [x] T-REG-510 超长场景回归：当目标章节 > 300 时，区间生成仍可按请求区间执行（不被全量上限错误拦截）。

## 发布检查清单
- [x] T-REL-601 API 文档更新（新增字段、优先级、错误码）。
- [x] T-REL-602 章节页交互文案更新（区间/覆盖行为说明）。
- [x] T-REL-603 迁移说明：旧项目如何从全量生成切换到区间滚动生成。
- [x] T-REL-604 验证数据备份与回滚方案（覆盖区间前可恢复）。
