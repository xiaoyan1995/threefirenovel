# SanhuoAI 任务清单（按天推进）

> 创建时间：2026-02-26  
> 目标：在不破坏现有功能的前提下，完成当前已确认的产品改造任务。  
> 强约束：关系图谱必须是独立板块，不放进任何现有页面。

## 使用方式

1. 每天只做“当日清单”中的项。
2. 每完成一项就打勾，并在文末“每日执行记录”补充结果。
3. 当日未完成项自动顺延到次日，不跳过回归检查。

## 全局验收标准

- [x] 旧功能不回归（项目切换、章节读写、AI 创作、节拍、围读、审核）。
- [x] 改写流程必须“先给建议正文 -> 用户确认 -> 替换原片段”。
- [x] 改写必须遵守节拍、背景资料与上下文约束。
- [x] 所有新增数据库改动均为增量迁移，不破坏旧数据。
- [x] 导入后的旧书可直接进入续写流程（含必要记忆回填）。

## 任务池（最终版）

### A. 写作工坊与交互

- [x] A01 文本框高度与布局收敛，减少视觉挤压。
- [x] A02 改写阈值参数（0-1）可配置并持久化（已上线，纳入回归核验）。
- [x] A03 改写遵循节拍/背景资料/上下文约束（含提示词与流程核验）。
- [x] A04 改写不直接改正文，改为建议正文确认后替换，不得追加到章末。
- [x] A05 写作助手聊天支持“清空对话”并保持局部改写范围约束。
- [x] A06 AI 痕迹检测改为弹窗交互，结果可读性修复。
- [x] A07 段落排版策略统一（段间空行或段首缩进）并固定为一个方案。

### B. 章节导航与界面一致性

- [x] B01 章节选择支持 `当前章/总章数`（如 `1/76`，总章数动态）。
- [x] B02 章节下拉可滚动，且不透明（禁用透明底）。
- [x] B03 全局下拉样式统一为不透明方案（含滚动条可见性）。
- [x] B04 导航栏支持收缩/展开，不影响原有导航功能。

### C. 审核中心与逻辑改稿

- [x] C01 审核中心支持“整本/按章节”两种审阅范围。
- [x] C02 审核评分卡修复（避免四项全 0 的无效展示）。
- [x] C03 审核文本展示修复（避免大段粘连，按段落/条目展示）。
- [x] C04 逻辑问题建议支持“生成建议正文 -> 用户确认 -> 应用正文”。
- [x] C05 大量逻辑错误场景下支持“全章重写建议”策略。

### D. 导入导出与续写

- [x] D01 项目导出（覆盖章节与主要板块数据）。
- [x] D02 小说格式导出（TXT/Markdown 至少一种，JSON 结构化导出）。
- [x] D03 旧书导入新项目，自动填充可映射板块。
- [x] D04 导入后可直接续写（章节/上下文/记忆链路可用）。

### E. 独立关系图谱板块

- [x] E01 新增独立“关系图谱”路由与侧栏入口。
- [x] E02 基于现有角色与关系数据提供图谱 API。
- [x] E03 图谱基础交互（节点点击、关系详情、证据文本、搜索定位）。
- [x] E04 与现有页面解耦，不嵌入写作工坊/审核中心。
- [x] E05 关系标签细化：500关系词典作为参考库，按实际文本优先判定并保留自定义关系。
- [x] E06 关系自动识别增强：从正文段落自动推断关系（手填关系仅作补充）。
- [x] E07 关系图谱章节联动：支持全局/章节视图，关系展示首次/最近/变化章节。

### F. 参考项目能力吸收（可选增强）

- [x] F01 吸收 Silverfish 的可复用交互模式（搜索聚焦、证据面板）。
- [x] F02 评估 MiroFish 可借鉴能力，仅做能力迁移不直接耦合。
- [x] F03 许可证与合规检查（避免直接复制引发 AGPL 连带风险）。

## 按天推进清单

## Day 1

- [x] 建立回归基线清单与快速验证脚本（手动/自动均可）。
- [x] 锁定写作工坊改写链路改造范围（仅改必要组件）。
- [x] 输出当天变更说明与风险点。

## Day 2

- [x] 完成改写“建议->确认->替换”主流程闭环。
- [x] 修复改写误追加到章末的问题。
- [x] 完成改写遵循节拍约束的回归验证。

## Day 3

- [x] 完成章节 `当前/总数` 选择器。
- [x] 完成章节下拉不透明+滚动条修复。
- [x] 完成全局下拉控件不透明策略统一。

## Day 4

- [x] 完成导航栏收缩/展开能力。
- [x] 完成 AI 痕迹弹窗化与展示修复。
- [x] 完成写作助手聊天清空与局部改写范围回归。

## Day 5

- [x] 完成审核中心“整本/章节”范围切换。
- [x] 完成评分卡和文本排版修复。
- [x] 完成逻辑问题“建议正文->确认应用”链路打通。

## Day 6

- [x] 完成项目导出后端接口（结构化 JSON）。
- [x] 完成小说文本导出（TXT/Markdown）。
- [x] 完成导出前端入口与下载流程。

## Day 7

- [x] 完成旧书导入后端解析与入库映射。
- [x] 完成导入前端入口和导入结果回显。
- [x] 完成导入异常兜底（编码、段落、空内容、超长文本）。

## Day 8

- [x] 完成导入后续写可用性修复（章节上下文链路）。
- [x] 完成必要记忆回填策略（最小可用版）。
- [x] 完成导入后首次续写验证。

## Day 9

- [x] 完成关系图谱独立页面与路由挂载。
- [x] 完成图谱后端查询 API（角色、关系、可选证据）。
- [x] 完成侧栏入口与页面基础状态管理。

## Day 10

- [x] 完成图谱前端渲染与基础交互（点击/搜索/详情）。
- [x] 完成图谱与现有页面隔离验证。
- [x] 完成图谱性能初测（中等规模数据）。

## Day 11

- [x] 吸收参考项目可复用交互点（优先 Silverfish）。
- [x] 完成可视化细节增强（关系证据、聚焦体验）。
- [x] 完成许可证与合规复核记录。

## Day 12

- [x] 全链路回归测试（写作、章节、审核、导入导出、图谱）。
- [x] 修复遗留问题并冻结版本。
- [x] 输出发布说明与下一阶段 backlog。

## 每日执行记录

### Day 1 记录

- 日期：2026-02-26
- 完成项：后端新增项目导入导出接口与记忆回填；审核中心运行接口（整本/章节）；关系图谱 API；前端完成导入导出入口、审核中心改版、写作工坊章节 `当前/总数` 跳转、AI 痕迹弹窗化、逻辑冲突建议正文（含全章重写建议）、侧栏收缩、独立关系图谱页面与路由。
- 风险/问题：导入异常兜底与导入后首次续写场景仍需真实数据回归；图谱性能仅完成功能级验证，未做中等规模压力测。
- 明日计划：补导入异常兜底回归、补图谱性能测试与参考项目能力吸收（Silverfish/MiroFish）。

### Day 2 记录

- 日期：2026-02-26
- 完成项：补充导入/图谱烟测脚本执行；补充内存链路回归；补充构建与后端编译验证；完成回归基线文档（`docs/plans/2026-02-26-regression-baseline.md`）。
- 风险/问题：前端纯视觉体验（图标观感、密度偏好）仍建议人工走查。
- 明日计划：若无新需求，进入稳定期与观察期。

### Day 3 记录

- 日期：
- 完成项：
- 风险/问题：
- 明日计划：

### Day 4 记录

- 日期：
- 完成项：
- 风险/问题：
- 明日计划：

### Day 5 记录

- 日期：
- 完成项：
- 风险/问题：
- 明日计划：

### Day 6 记录

- 日期：
- 完成项：
- 风险/问题：
- 明日计划：

### Day 7 记录

- 日期：
- 完成项：
- 风险/问题：
- 明日计划：

### Day 8 记录

- 日期：
- 完成项：
- 风险/问题：
- 明日计划：

### Day 9 记录

- 日期：
- 完成项：
- 风险/问题：
- 明日计划：

### Day 10 记录

- 日期：
- 完成项：
- 风险/问题：
- 明日计划：

### Day 11 记录

- 日期：
- 完成项：
- 风险/问题：
- 明日计划：

### Day 12 记录

- 日期：2026-02-26
- 完成项：完成全链路回归与冻结检查；已输出发布说明与下一阶段 backlog（`docs/plans/2026-02-26-release-notes-and-backlog.md`）。
- 风险/问题：无阻塞性问题。
- 明日计划：进入稳定观察期，按 backlog 节奏推进。
