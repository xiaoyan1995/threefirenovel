# 三火AI 可执行优化方案（Implementation Plan v2）

这版方案不是愿景清单，而是按当前代码状态可直接执行的重构计划。目标是：

1. 先修地基（数据模型与迁移），避免后续反复返工。
2. 先交付用户可感知价值（CRUD闭环、聊天可见、自动保存）。
3. 高复杂功能分阶段做 MVP，不一次性承诺“终局能力”。

---

## 一、当前基线（基于现有代码）

### 已具备能力
- 前端：`React + Vite + Tauri`，页面骨架完整，项目/章节/角色/大纲等基础列表可用。
- 后端：`FastAPI + SQLite`，已有项目、章节、角色、内容、设置等 API。
- Agent：已有 5 类 Agent 路由和工作流入口。

### 关键缺口
- 数据模型与代码存在不一致，部分功能依赖的表/字段在基础 schema 中缺失。
- 迁移机制未纳入应用启动主流程。
- 核心交互未闭环：可创建但缺编辑/删除入口，工坊 AI 输入框未形成完整对话流。

---

## 二、优先级重排原则

### P0（必须先做）
- 任何会导致“新环境启动失败 / 运行报错 / 数据写不进去”的问题。

### P1（强用户价值）
- 用户马上能感知的体验改进：可编辑、可删除、可看见 AI 回复、可自动保存。

### P2（中期能力）
- 提升创作质量的核心生产力模块：节拍表、双轨生成。

### P3（主线高复杂能力）
- 高复杂主线功能：NER 溯源、蝴蝶效应推演、多 Agent 辩论。

---

## 三、实施阶段

## 阶段 0（P0）：数据模型与后端稳定性修复

### 目标
先让系统“可靠可跑”，再谈高级功能。

### 任务
- 对齐数据库 schema 与实际代码读写字段。
- 将迁移机制接入启动流程，保证新用户环境可自动补齐结构。
- 增加启动自检与失败日志，避免“页面空白但无报错”的隐性故障。

### 建议改动
#### [MODIFY] database/schema.sql
- 补齐设置相关表：`model_configs`、`provider_configs`。
- 对齐记忆相关字段（按实际代码使用补齐或同步调整代码）。

#### [NEW] database/migrations/*.sql
- 从当前线上/本地常见版本向目标 schema 增量迁移。
- 每个迁移可重复执行且幂等。

#### [MODIFY] agent/main.py
- 启动时执行迁移，再启动 API 服务。

#### [MODIFY] agent/migrate_db.py
- 统一迁移目录解析逻辑与错误提示。

### 验收标准
- 新空数据库首次启动不报错。
- 设置页相关接口可正常读写。
- Agent 记忆写入链路不再因字段缺失失败。
- 启动日志可明确看到 schema 版本/迁移结果。

---

## 阶段 1（P1）：基础交互闭环（先把“能用”做扎实）

### 目标
完成创作主链路的最小闭环：项目 -> 大纲/角色 -> 工坊写作 -> AI 辅助。

### 任务 A：补齐编辑与删除
#### [MODIFY] src/pages/Outline.tsx
#### [MODIFY] src/pages/Characters.tsx
#### [MODIFY] src/pages/Worldbuilding.tsx
#### [MODIFY] src/pages/Foreshadowing.tsx
#### [NEW] src/components/ui/EditDrawer.tsx
- 卡片点击打开编辑抽屉/弹窗。
- 增加删除动作与二次确认。
- 提交成功后局部刷新，不强制整页重载。

### 任务 B：工坊 AI 对话面板闭环
#### [MODIFY] src/pages/Workshop.tsx
- 增加消息列表（用户/AI）。
- 发送按钮真正调用 `/agent/invoke`。
- 错误反馈可见（而不是 silent fail）。

### 任务 C：自动保存
#### [MODIFY] src/pages/Workshop.tsx
- 内容变化后 debounce 自动保存（2-3 秒）。
- 显示“已保存/保存中/保存失败”状态。
- 离开页面前未保存内容提示。

### 任务 D：新建项目体验优化
#### [MODIFY] src/pages/Projects.tsx
#### [NEW] src/components/projects/CreateProjectModal.tsx
- 先填写名称/类型再创建，替代默认“新项目”空壳跳转。

### 验收标准
- 角色/大纲/设定条目可创建、编辑、删除。
- 工坊发消息后能看到 AI 回复。
- 连续输入时可自动保存且不会明显卡顿。
- 新建项目流程可一次完成基础信息填写。

---

## 阶段 2（P1.5）：类型、错误与可维护性治理

### 目标
降低“功能看似可用但稳定性差”的长期维护成本。

### 任务
#### [NEW] src/types/*
- 抽离统一类型：Project、Chapter、Character、APIResponse 等。

#### [NEW] src/components/ui/ToastProvider.tsx
#### [MODIFY] src/context/ProjectContext.tsx
- 全局错误提示通道，替换主要页面中的 `.catch(() => {})`。

#### [MODIFY] src/pages/Settings.tsx
#### [NEW] src/components/settings/*
- 拆分设置页大组件，降低耦合与无关重渲染。

### 样式策略（调整优先级）
- 不做“全量 Tailwind 迁移”单独立项。
- 采用“触达式重构”：改到哪个模块，就顺手把该模块样式清理到位。

### 验收标准
- 核心页面无 silent catch。
- 关键 API 返回失败时用户可见提示。
- 设置页模块拆分后行为不回归。

---

## 阶段 3（P2）：小说生产力 MVP（先做最值钱的两个）

### 目标
优先解决 AI 写作“流水账”问题。

### 任务 A：多级细纲与节拍表（MVP）
#### [MODIFY] src/pages/Outline.tsx
#### [MODIFY] src/pages/Chapters.tsx
#### [NEW] src/components/editor/BeatSheetSidebar.tsx
#### [NEW] agent/api/beats.py
#### [NEW] database/migrations/*_beats.sql
- 最小模型：`chapter_beats`（章节下 3-5 个 beat）。
- 支持 AI 生成节拍草案 + 手工编辑。

### 任务 B：双轨生成引擎（MVP）
#### [MODIFY] src/pages/Workshop.tsx
#### [MODIFY] src/pages/Settings.tsx
#### [MODIFY] agent/agents/workflow.py
- 模式 1：速度优先（一次成稿）。
- 模式 2：质量优先（按 beat 分段生成+确认）。

### 验收标准
- 每章可保存节拍表并用于生成。
- 两种生成模式可切换，结果差异清晰可见。

---

## 阶段 4（P3）：高复杂能力（主线必做，分批落地）

以下能力全部纳入主线版本，按“PoC -> Beta -> 正式发布”分批推进：

#### [主线A] 动态设定提取与实体溯源 (NER)
**目标:** 写作过程中，系统能实时识别用户当前文字中的“已知实体”，并在侧边栏动态高亮；同时，后台可通过大模型“无感提取”可能的新实体，推荐录入设定集。
**技术方案:**
- **后端 (`agent/api/ner.py`)**: 
  - `POST /api/ner/extract`: 接收文本，调用大模型提取文本中的人名、地名、势力、物品，并与数据库中现有的设定对比，返回“已知实体”与“潜在新实体”。
- **前端 (`src/pages/Workshop.tsx` + `src/components/editor/EntityHighlighter.tsx`)**:
  - **动态上下文**: 当用户停止打字 (debounce 2s)，调用 NER 分析，在右侧上下文面板置顶展示“当前段落提及的设定”，并提供一键录入功能。
  - **沉浸式阅读模式 (溯源)**: 由于纯 `<textarea>` 无法内嵌交互标签，提供一个 `阅读溯源` 模式按键。开启后隐藏输入框，显示排版精美的 Rich Text，文中所有识别到的实体带有下划线高亮，鼠标悬浮（Hover）时通过 Tooltip 弹出其身份与关系描述。

#### [主线B] 一致性检测与冲突标注
**目标:** 解决长篇小说常见的吃书、设定矛盾问题（如死人复活、战力崩坏、物品瞬间移动）。提供一个“逻辑审查”工具，主动扫描章节与全局大纲/设定的冲突。
**技术方案:**
- **后端 (`agent/api/conflict.py`)**:
  - `POST /api/conflict/check`: 接收当前章节文本。
  - **流程**: 
    1. 提取当前文本的关键事件。
    2. 利用语义检索 (RAG) 去 `memory_chunks` 和实体表中搜索相关前置设定。
    3. 运用大模型 (Reviewer 角色) 进行交叉对比，找出逻辑漏勺。
  - **输出**: 返回冲突列表（包含：冲突类型、原文引用、矛盾说明、建议修改方向）。
- **前端 (`src/pages/Workshop.tsx` + `src/components/editor/ConflictPanel.tsx`)**:
  - 在编辑器工具栏新增 **[逻辑扫描]** 操作。
  - 在右侧边栏新增 **[逻辑审查]** Tab。扫描完成后，以卡片形式列出所有疑似冲突。
  - 点击冲突卡片，展示 AI 的详细分析与修改建议，辅助完成自查闭环。

#### [主线C] 多 Agent 协同推演室 (剧本围读)
**目标:** 打破单一 AI 写手的思维局限，让多个拥有不同“性格”和“本位职责”的 Agent（如：挑剔的读者、激进的反派扮演者、注重埋线的编剧）围坐一桌，对下一个剧情走向进行回合制辩论，最终汇总出一套最优方案。
**技术方案:**
- **后端 (`agent/agents/debate_room.py`)**:
  - `POST /api/agents/debate`: 接收用户的话题（如：“主角接下来该怎么处理这具尸体？”）。
  - **流程 (LangGraph)**:
    1. **Director (导演)** 接管话题，将其分发给三个子节点 Agent（例如：`ReaderAgent`, `VillainAgent`, `WorldbuilderAgent`）。
    2. 子节点 Agent 相互独立发言，给出不同视角的建议。
    3. **Director** 收集所有建议后，进行归纳融合，输出最终推演报告。
    4. Server-Sent Events (SSE) 逐步流式推送辩论过程，让前端看到它们“群聊”的实时过程。
- **前端 (`src/pages/DebateRoom.tsx`)**:
  - 新增一个独立的“推演室”顶级路由页面（因为在写作工坊侧边栏塞不下这么庞大的群聊界面）。
  - 界面为“类似微信群聊”的 UI，左侧是多个 AI 的头像和不同气泡，底部是输入框。
  - 用户抛出话题，看着它们几个互相提意见，最后挑选自己喜欢的采纳。

#### [主线D] 蝴蝶效应推演板 (网状逻辑修补)
**目标:** 长篇连载最怕的就是“牵一发而动全身”。当作者想要修改开头的一个基本设定（例如：把死去的师傅写活），如果手动去改，很容易忘记后面有几十处剧情都依赖于师傅的死。推演板的目的是：输入一个假设的修改，自动列出**所有受影响的后续大纲节点**，并给出修复建议方案。
**技术方案:**
- **后端 (`agent/api/butterfly.py`)**:
  - `POST /api/butterfly/simulate`: 接收 `project_id` 和 `supposition`（假设性修改，如：“如果张三在第三章没有死？”）。
  - **流程**:
    1. **提取全量大纲链**: 从数据库中按顺序拉取所有 `chapters`（带摘要 summary）或 `chapter_beats`。
    2. **AI 影响图谱推演**: 让高配模型 (GPT-4o) 将这个“假设”代入从前往后的大纲时间轴中，找出每一个会因为这个假设而产生逻辑断裂（崩坏）的后续章节。
    3. 生成详细的推演报告，返回各个受冲击节点的 ID、原文描述、断裂原因和修补建议。
- **前端 (`src/pages/ButterflyBoard.tsx`)**:
  - 新增顶级路由页面 `蝴蝶推演板`。
  - 界面左侧为输入区，写下你的“疯狂脑洞/悔棋设定”。
  - 右侧/底部展示为类似“多米诺骨牌”倒塌的节点列表，红色的卡片表示受到波及的后续章节，绿色的建议提醒你应该如何打补丁。

---

## 四、测试与质量门禁（新增）

## 后端
- API 冒烟：项目/章节/角色/内容/设置主路径全覆盖。
- 迁移测试：空库 + 老库升级都能通过。
- 关键回归：保存段落、Agent 调用、配置读写。

## 前端
- 页面级冒烟：项目页、工坊、设置页、角色页。
- 关键交互：编辑/删除/自动保存/聊天发送。
- 错误场景：Agent 未启动、接口超时、保存失败。

## 发布门禁
- 所有 P0/P1 用例通过后才进入下一阶段。

---

## 五、里程碑建议（可按周执行）

1. M1（1 周）：完成阶段 0，系统稳定启动与数据对齐。
2. M2（1-2 周）：完成阶段 1，创作主链路闭环。
3. M3（1 周）：完成阶段 2，类型与错误治理。
4. M4（2 周）：完成阶段 3 MVP（节拍表 + 双轨生成）。
5. M5（2-3 周）：完成阶段 4 的主线A + 主线B。
6. M6（2-3 周）：完成阶段 4 的主线C + 主线D 并联调整体发布。

---

## 六、当前版本先做什么（建议立即开工）

### 第一批（本周）
- 阶段 0 全部。
- 阶段 1 中“编辑/删除 + 工坊聊天记录”。

### 第二批（下周）
- 阶段 1 中“自动保存 + 新建项目弹窗”。
- 阶段 2 中“全局错误提示 + 类型收敛”。

---

## 七、说明

原方案中的长期方向（记忆利用、叙事控制、协同 Agent）全部保留并纳入主线，但以“分层可验证落地”方式推进。  
执行顺序已改为：**先修稳定性，再补交互闭环，再上高阶能力**。
